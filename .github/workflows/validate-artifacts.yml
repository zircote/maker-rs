---
name: Validate Artifacts

"on":
  push:
    branches: [main]
    paths:
      - '*.md'
      - '.github/**'
  pull_request:
    branches: [main]

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check required artifacts exist
        run: |
          required_files=(
            "PROJECT-PLAN.md"
            "GANTT-CHART.md"
            "JIRA-STRUCTURE.md"
            "RACI-CHART.md"
            "RISK-REGISTER.md"
            "SEVERITY-CLASSIFICATION.md"
            "BEST-PRACTICES.md"
            "SUCCESS-METRICS.md"
            "RUNBOOK-TEMPLATE.md"
            "README.md"
            "CHANGELOG.md"
            "_research/DOMAIN-RESEARCH.md"
            "_research/DEPENDENCY-ANALYSIS.md"
          )
          missing=0
          for f in "${required_files[@]}"; do
            if [ ! -f "$f" ]; then
              echo "MISSING: $f"
              missing=$((missing + 1))
            else
              echo "OK: $f"
            fi
          done
          if [ $missing -gt 0 ]; then
            echo ""
            echo "$missing required artifact(s) missing."
            echo "Run @project-architect to generate all artifacts."
            exit 1
          fi

      - name: Check for placeholder content
        run: |
          placeholder_count=0
          pat='\[TODO\]|\[TBD\]|\[PLACEHOLDER\]|\[INSERT\]'
          for f in *.md; do
            if grep -qE "$pat" "$f" 2>/dev/null; then
              echo "PLACEHOLDER CONTENT in $f:"
              grep -nE "$pat" "$f"
              placeholder_count=$((placeholder_count + 1))
            fi
          done
          if [ $placeholder_count -gt 0 ]; then
            echo ""
            echo "Found placeholder content in $placeholder_count file(s)."
            exit 1
          fi
          echo "No placeholder content found."

      - name: Validate internal links
        run: |
          broken=0
          for f in *.md; do
            while IFS= read -r target; do
              if [[ "$target" == http* ]] || [[ "$target" == "#"* ]]; then
                continue
              fi
              if [ ! -f "$target" ]; then
                echo "BROKEN LINK in $f: $target"
                broken=$((broken + 1))
              fi
            done < <(grep -oP '\[.*?\]\(\K[^)]+' "$f" 2>/dev/null || true)
          done
          if [ $broken -gt 0 ]; then
            echo ""
            echo "$broken broken internal link(s) found."
            exit 1
          fi
          echo "All internal links valid."
